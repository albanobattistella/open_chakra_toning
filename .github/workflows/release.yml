# Build and release versions of the app.
name: release

on:
  push:
    branches:
    - main
    tags:
    - v*
  pull_request:
  schedule:
    - cron: '14 7 * * 0'  # run once a week on Sunday
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: update dependencies
        run: sudo apt update
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
      - run: flutter pub get
      - run: flutter test
      - name: create artifatcs directory
        run: mkdir -p artifacts
      - name: build Linux - install depenencies
        run: sudo apt install -qq libgtk-3-0 libblkid1 liblzma5 ninja-build libgtk-3-dev clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev libgstreamer1.0-dev libunwind-dev libgstreamer-plugins-base1.0-dev gstreamer1.0-plugins-good gstreamer1.0-plugins-bad
      - name: build Linux
        run: |
          flutter build linux
          target="build/linux/x64/release/Open-Chakra-Toning"
          mv build/linux/x64/release/bundle "$target"
          # add files for flatpak build
          cp -r \
            flatpak/inside.sh \
            flatpak/eu.quelltext.open_chakra_toning.metainfo.xml \
            flatpak/eu.quelltext.open_chakra_toning.desktop \
            flatpak/open_chakra_toning.sh \
            assets/img/icon \
            "$target"
          (
            cd build/linux/x64/release/
            zip -r Open-Chakra-Toning-linux-x64.zip Open-Chakra-Toning
          )
          mv build/linux/x64/release/Open-Chakra-Toning-linux-x64.zip artifacts
      - name: build Android
        run: |
          flutter build apk
          mv build/app/outputs/flutter-apk/app-release.apk artifacts/eu.quelltext.open_chakra_toning.apk
#      - run: flutter build appbundle
      - name: build web
        run: |
          flutter build web
          (
            cd build
            mv web Open-Chakra-Toning
            zip -r ../artifacts/Open-Chakra-Toning-web.zip Open-Chakra-Toning
          )
      - uses: actions/upload-artifact@v4
        with:
          name: artifacts
          path: artifacts/*

  flatpak:
    name: "Flatpak"
    runs-on: ubuntu-latest
    needs:
      - build
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:gnome-44
      options: --privileged
    steps:
    - uses: actions/checkout@v4
    - uses: actions/download-artifact@master
      with:
        name: artifacts
        path: artifacts/
    - name: unpack linux build
      run: |
        (
          cd flatpak
          unzip ../artifacts/Open-Chakra-Toning-linux-x64.zip
        )
    - name: flatpack - build
      uses: flathub-infra/flatpak-github-actions/flatpak-builder@master
      with:
        bundle: Open-Chakra-Toning-linux.flatpak
        manifest-path: flatpak/eu.quelltext.open_chakra_toning.yml
    - name: "find flatpak and add it to the artifacts"
      run: |
        find | grep .flatpak
        mv *.flatpak artifacts/
    - uses: actions/upload-artifact@v4
      with:
        name: artifacts
        path: artifacts/*
        overwrite: true

  deploy-github-release:
    # only deploy on tags, see https://stackoverflow.com/a/58478262/1320237
    if: startsWith(github.ref, 'refs/tags/v')
    needs:
      - build
      - flatpak
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: retrieve build artifacts
        uses: actions/download-artifact@master
        with:
          name: artifacts
          path: artifacts/
      - name: create release
        uses: ncipollo/release-action@v1 # see https://github.com/ncipollo/release-action
        with:
          allowUpdates: true
          artifacts: "artifacts/*"
